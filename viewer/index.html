<html>
  <head>
    <title>finite element method</title>
  </head>

  <body bgcolor="#808080">
    <h1>finite element method</h1>
    <canvas id="canvas"></canvas>
  </body>

  <script lang="javascript">
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d", {willReadFrequently: true});
    let img_width = 0;
    let img_height = 0;

    async function setup_canvas() {
      const img_width_re = /#define IMAGE_WIDTH (.*)\n/;
      const img_height_re = /#define IMAGE_HEIGHT (.*)\n/;

      const macro_def = await fetch("macro_def.h")
        .then((response) => response.text())

      img_width = eval(macro_def.match(img_width_re)[1]);
      img_height = eval(macro_def.match(img_height_re)[1]);

      canvas.setAttribute("width", img_width);
      canvas.setAttribute("height", img_height);

    }

    function setup_draw() {
      const websocket = new WebSocket("ws://localhost:9743");
      websocket.binaryType = "arraybuffer";

      websocket.onmessage = (event) => {
        // clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#000000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const data = new DataView(event.data)
        const DIM = 2;
        const ntriangles = data.byteLength / ((3*DIM + 1) * 4);

        // draw stress colors
        for (let i = 0; i < ntriangles; i++) {
          const stress = data.getInt32(4*((i+1)*(3*DIM + 1) - 1), true);
          for (let j = 0; j < 3; j++) {
            const x = Array();
            for (let k = 0; k < DIM; k++) {
              const idx = i*(3*DIM + 1) + j*DIM + k;
              x.push(data.getInt32(4*idx, true));
            }

            if (j == 0) {
              ctx.beginPath();
              ctx.moveTo(x[0], x[1]);
            } else {
              ctx.lineTo(x[0], x[1]);
            }
          }

          ctx.fillStyle = `hsl(${stress}, 100%, 50%)`;
          ctx.fill();
        }

        // draw grid
        for (let i = 0; i < ntriangles; i++) {
          const stress = data.getInt32(4*((i+1)*(3*DIM + 1) - 1), true);
          for (let j = 0; j < 3; j++) {
            const x = Array();
            for (let k = 0; k < DIM; k++) {
              const idx = i*(3*DIM + 1) + j*DIM + k;
              x.push(data.getInt32(4*idx, true));
            }

            if (j == 0) {
              ctx.beginPath();
              ctx.moveTo(x[0], x[1]);
            } else {
              ctx.lineTo(x[0], x[1]);
            }
          }

          ctx.lineWidth = 0.5;
          ctx.strokeStyle = "#000000";
          ctx.stroke();
        }
      };

      websocket.onopen = (event) => {console.log("connected");};

      websocket.onclose = (event) => {
        setTimeout(setup_draw, 1000);
      };
    }

    setup_canvas();
    setup_draw();
  </script>
</html>
